<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ˜æ”¾ç½® - Civilization Idle</title>
    <style>
:root {
    --bg-color: #1a1a2e;
    --panel-bg: #16213e;
    --card-bg: #0f3460;
    --accent: #e94560;
    --text: #eaeaea;
    --text-muted: #a0a0a0;
    --success: #4ecca3;
    --warning: #ffa500;
    --danger: #ff4757;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
    background: var(--bg-color);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
}
#game-container { max-width: 900px; margin: 0 auto; }
header {
    background: var(--panel-bg);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    position: relative;
}
header h1 { font-size: 28px; margin-bottom: 10px; }
#game-time { font-size: 18px; color: var(--text-muted); }
#offline-popup {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--warning);
    color: #000;
    padding: 15px 20px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 400px;
}
#offline-popup.hidden { display: none; }
#offline-popup button {
    background: #000;
    color: #fff;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-weight: bold;
}
#tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.tab-btn {
    background: var(--panel-bg);
    color: var(--text);
    border: 2px solid transparent;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
}
.tab-btn:hover { background: var(--card-bg); }
.tab-btn.active { border-color: var(--accent); background: var(--card-bg); }
.panel {
    display: none;
    background: var(--panel-bg);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}
.panel.active { display: block; }
.panel h2 { margin-bottom: 15px; font-size: 22px; }
.panel h3 { margin: 20px 0 10px; font-size: 18px; color: var(--text-muted); }
#resources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.resource-card {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    transition: transform 0.2s;
}
.resource-card:hover { transform: translateY(-3px); }
.resource-icon { font-size: 32px; margin-bottom: 5px; }
.resource-name { font-size: 12px; color: var(--text-muted); margin-bottom: 5px; }
.resource-amount { font-size: 20px; font-weight: bold; }
.resource-max { font-size: 12px; color: var(--text-muted); }
#production-rates {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.rate {
    background: var(--card-bg);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
}
.rate.positive { color: var(--success); }
.rate.negative { color: var(--danger); }
.population-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
}
#jobs-list { margin-bottom: 20px; }
.job-item {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.job-info { display: flex; align-items: center; gap: 10px; }
.job-icon { font-size: 24px; }
.job-name { font-weight: bold; }
.job-desc { color: var(--text-muted); font-size: 14px; }
.job-controls {
    display: flex;
    align-items: center;
    gap: 10px;
}
.job-controls button {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--accent);
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    transition: opacity 0.2s;
}
.job-controls button:disabled { opacity: 0.5; cursor: not-allowed; }
.job-controls span { min-width: 30px; text-align: center; font-weight: bold; }
.action-btn {
    background: var(--success);
    color: #000;
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: opacity 0.2s;
}
.action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
#buildings-list, #tech-tree {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.building-item, .tech-item {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.building-item.disabled, .tech-item.disabled { opacity: 0.6; }
.building-info, .tech-info { display: flex; align-items: center; gap: 15px; }
.building-icon, .tech-icon { font-size: 32px; }
.building-name, .tech-name { font-weight: bold; margin-bottom: 5px; }
.building-desc, .tech-desc { color: var(--text-muted); font-size: 14px; margin-bottom: 5px; }
.building-cost, .tech-cost { font-size: 13px; }
.can-afford { color: var(--success); }
.cannot-afford { color: var(--danger); }
.building-item button, .tech-item button {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: opacity 0.2s;
}
.building-item button:disabled, .tech-item button:disabled { opacity: 0.5; cursor: not-allowed; }
.tech-item.researched { background: var(--success); color: #000; }
.explore-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin-bottom: 20px;
    transition: opacity 0.2s;
}
.explore-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.tile {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.tile-icon { font-size: 24px; }
#event-log {
    max-height: 300px;
    overflow-y: auto;
    background: var(--card-bg);
    padding: 15px;
    border-radius: 8px;
}
.log-entry {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 14px;
}
.log-entry:last-child { border-bottom: none; }
footer {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.footer-btn {
    background: var(--card-bg);
    color: var(--text);
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}
.footer-btn:hover { background: var(--accent); }
.footer-btn.danger:hover { background: var(--danger); }
@media (max-width: 600px) {
    body { padding: 10px; }
    #tabs { gap: 5px; }
    .tab-btn { padding: 10px 15px; font-size: 14px; }
    #resources-grid { grid-template-columns: repeat(3, 1fr); }
    .building-info, .tech-info { flex-direction: column; align-items: flex-start; gap: 5px; }
}
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <h1>ğŸ›ï¸ æ–‡æ˜æ”¾ç½®</h1>
            <div id="game-time">ç¬¬ <span id="year">1</span> å¹´</div>
            <div id="offline-popup" class="hidden">
                <span id="offline-message"></span>
                <button onclick="dismissOffline()">âœ“</button>
            </div>
        </header>

        <nav id="tabs">
            <button class="tab-btn active" data-tab="resources">ğŸ“¦ èµ„æº</button>
            <button class="tab-btn" data-tab="population">ğŸ‘¥ äººå£</button>
            <button class="tab-btn" data-tab="buildings">ğŸ—ï¸ å»ºç­‘</button>
            <button class="tab-btn" data-tab="tech">ğŸ”¬ ç§‘æŠ€</button>
            <button class="tab-btn" data-tab="world">ğŸŒ ä¸–ç•Œ</button>
        </nav>

        <section id="resources-panel" class="panel active">
            <h2>èµ„æºå‚¨é‡</h2>
            <div id="resources-grid"></div>
            <h3>ç”Ÿäº§æ•ˆç‡</h3>
            <div id="production-rates"></div>
        </section>

        <section id="population-panel" class="panel">
            <h2>äººå£ç®¡ç†</h2>
            <div class="population-info">
                <div class="stat"><span>æ€»äººå£:</span><span id="total-pop">0</span></div>
                <div class="stat"><span>ç©ºé—²äººå£:</span><span id="idle-pop">0</span></div>
                <div class="stat"><span>äººå£ä¸Šé™:</span><span id="pop-cap">0</span></div>
                <div class="stat"><span>å¹¸ç¦åº¦:</span><span id="happiness">100%</span></div>
            </div>
            <h3>å·¥ä½œåˆ†é…</h3>
            <div id="jobs-list"></div>
            <button id="recruit-btn" class="action-btn">æ‹›å‹Ÿæ‘æ°‘ (-<span id="recruit-cost">10</span> é£Ÿç‰©)</button>
        </section>

        <section id="buildings-panel" class="panel">
            <h2>å»ºç­‘</h2>
            <div id="buildings-list"></div>
        </section>

        <section id="tech-panel" class="panel">
            <h2>ç§‘æŠ€æ ‘</h2>
            <div id="tech-tree"></div>
        </section>

        <section id="world-panel" class="panel">
            <h2>ä¸–ç•Œæ¢ç´¢</h2>
            <div id="world-map"></div>
            <h3>äº‹ä»¶æ—¥å¿—</h3>
            <div id="event-log"></div>
        </section>

        <footer>
            <button onclick="game.save()" class="footer-btn">ğŸ’¾ ä¿å­˜</button>
            <button onclick="game.exportSave()" class="footer-btn">ğŸ“¤ å¯¼å‡ºå­˜æ¡£</button>
            <button onclick="game.importSave()" class="footer-btn">ğŸ“¥ å¯¼å…¥å­˜æ¡£</button>
            <button onclick="game.hardReset()" class="footer-btn danger">âš ï¸ é‡ç½®</button>
        </footer>
    </div>

    <script>
// èµ„æºå®šä¹‰
const ResourceDefinitions = {
    food: { name: 'é£Ÿç‰©', icon: 'ğŸŒ¾', initial: 100, max: 500 },
    wood: { name: 'æœ¨æ', icon: 'ğŸªµ', initial: 50, max: 500 },
    stone: { name: 'çŸ³æ–™', icon: 'ğŸª¨', initial: 0, max: 300 },
    metal: { name: 'é‡‘å±', icon: 'âš™ï¸', initial: 0, max: 200 },
    gold: { name: 'é»„é‡‘', icon: 'ğŸª™', initial: 0, max: 1000 },
    research: { name: 'ç§‘ç ”ç‚¹', icon: 'ğŸ”¬', initial: 0, max: Infinity },
    culture: { name: 'æ–‡åŒ–', icon: 'ğŸ­', initial: 0, max: Infinity },
    faith: { name: 'ä¿¡ä»°', icon: 'â›ª', initial: 0, max: Infinity }
};

const JobDefinitions = {
    gatherer: { name: 'é‡‡é›†è€…', icon: 'ğŸ§º', description: 'é‡‡é›†é‡æœå’Œæœ¨æ (+0.5é£Ÿç‰©,+0.3æœ¨æ)', production: { food: 0.5, wood: 0.3 } },
    farmer: { name: 'å†œæ°‘', icon: 'ğŸ‘¨â€ğŸŒ¾', description: 'åœ¨å†œç”°è€•ä½œ (+1.2é£Ÿç‰©)', production: { food: 1.2 } },
    lumberjack: { name: 'ä¼æœ¨å·¥', icon: 'ğŸª“', description: 'ç ä¼æ ‘æœ¨ (+1.0æœ¨æ)', production: { wood: 1.0 } },
    miner: { name: 'çŸ¿å·¥', icon: 'â›ï¸', description: 'å¼€é‡‡çŸ¿çŸ³ (+0.5çŸ³æ–™,+0.2é‡‘å±)', production: { stone: 0.5, metal: 0.2 } },
    scholar: { name: 'å­¦è€…', icon: 'ğŸ“š', description: 'ç ”ç©¶ç§‘æŠ€ (+0.3ç§‘ç ”ç‚¹,æ¶ˆè€—0.5é£Ÿç‰©)', production: { research: 0.3 }, consumption: { food: 0.5 } },
    artisan: { name: 'å·¥åŒ ', icon: 'ğŸ”¨', description: 'åˆ¶ä½œå·¥å…· (+0.3é‡‘å±,+0.1é»„é‡‘)', production: { metal: 0.3, gold: 0.1 }, consumption: { wood: 0.3, stone: 0.2 } },
    priest: { name: 'ç¥­å¸', icon: 'ğŸ™', description: 'ä¼ æ’­ä¿¡ä»° (+0.2ä¿¡ä»°,+0.1æ–‡åŒ–)', production: { faith: 0.2, culture: 0.1 }, consumption: { food: 0.3 } },
    merchant: { name: 'å•†äºº', icon: 'ğŸ’°', description: 'è´¸æ˜“è·å¾—é»„é‡‘ (+0.5é»„é‡‘)', production: { gold: 0.5 }, consumption: { food: 0.2 } }
};

const BuildingDefinitions = {
    tent: { name: 'å¸ç¯·', icon: 'â›º', description: 'æä¾›2äººå£ä¸Šé™', cost: { wood: 20 }, effects: { popCap: 2 } },
    hut: { name: 'èŒ…å±‹', icon: 'ğŸ›–', description: 'æä¾›5äººå£ä¸Šé™', cost: { wood: 50, stone: 10 }, effects: { popCap: 5 }, requireTech: 'construction' },
    house: { name: 'æˆ¿å±‹', icon: 'ğŸ ', description: 'æä¾›10äººå£ä¸Šé™', cost: { wood: 100, stone: 50, metal: 10 }, effects: { popCap: 10 }, requireTech: 'masonry' },
    farm: { name: 'å†œåœº', icon: 'ğŸšœ', description: 'è‡ªåŠ¨ç”Ÿäº§é£Ÿç‰©(+0.5/ç§’)', cost: { wood: 30, stone: 10 }, production: { food: 0.5 }, requireTech: 'agriculture' },
    lumberMill: { name: 'é”¯æœ¨å‚', icon: 'ğŸ­', description: 'è‡ªåŠ¨ç”Ÿäº§æœ¨æ(+0.4/ç§’)', cost: { wood: 50, stone: 20 }, production: { wood: 0.4 }, requireTech: 'tools' },
    quarry: { name: 'é‡‡çŸ³åœº', icon: 'ğŸ—ï¸', description: 'è‡ªåŠ¨ç”Ÿäº§çŸ³æ–™(+0.3/ç§’)', cost: { wood: 80, metal: 10 }, production: { stone: 0.3 }, requireTech: 'mining' },
    mine: { name: 'çŸ¿äº•', icon: 'â›ï¸', description: 'è‡ªåŠ¨ç”Ÿäº§é‡‘å±(+0.2/ç§’)', cost: { wood: 100, stone: 50 }, production: { metal: 0.2 }, requireTech: 'mining' },
    barn: { name: 'ç²®ä»“', icon: 'ğŸŒ¾', description: 'å¢åŠ é£Ÿç‰©å‚¨å­˜ä¸Šé™+200', cost: { wood: 40 }, effects: { resourceMax: { food: 200 } } },
    warehouse: { name: 'ä»“åº“', icon: 'ğŸ“¦', description: 'å¢åŠ èµ„æºå‚¨å­˜ä¸Šé™+100', cost: { wood: 100, stone: 50 }, effects: { resourceMax: { wood: 100, stone: 100, metal: 100, gold: 100 } }, requireTech: 'construction' },
    library: { name: 'å›¾ä¹¦é¦†', icon: 'ğŸ“–', description: 'è‡ªåŠ¨ç”Ÿäº§ç§‘ç ”ç‚¹(+0.2/ç§’)', cost: { wood: 150, stone: 100 }, production: { research: 0.2 }, requireTech: 'writing' },
    temple: { name: 'ç¥æ®¿', icon: 'â›ª', description: 'è‡ªåŠ¨ç”Ÿäº§ä¿¡ä»°å’Œæ–‡åŒ–', cost: { stone: 200, gold: 20, metal: 30 }, production: { faith: 0.1, culture: 0.1 }, requireTech: 'religion' },
    market: { name: 'å¸‚åœº', icon: 'ğŸª', description: 'è‡ªåŠ¨ç”Ÿäº§é»„é‡‘(+0.3/ç§’)', cost: { wood: 100, stone: 50, gold: 10 }, production: { gold: 0.3 }, requireTech: 'currency' },
    academy: { name: 'å­¦é™¢', icon: 'ğŸ“', description: 'å¤§å¹…æå‡ç§‘ç ”(+0.5/ç§’)', cost: { wood: 300, stone: 200, metal: 50 }, production: { research: 0.5 }, requireTech: 'philosophy' }
};

const TechDefinitions = {
    tools: { name: 'å·¥å…·åˆ¶ä½œ', icon: 'ğŸ”¨', description: 'æœ¨æå’ŒçŸ³æ–™äº§é‡+20%', cost: { research: 20 }, requires: [], startUnlocked: true },
    fire: { name: 'ç”Ÿç«', icon: 'ğŸ”¥', description: 'å¹¸ç¦åº¦+10%', cost: { research: 30 }, requires: [], startUnlocked: true },
    agriculture: { name: 'å†œä¸š', icon: 'ğŸŒ¾', description: 'è§£é”å†œåœºï¼Œé£Ÿç‰©+30%', cost: { research: 50 }, requires: ['tools'] },
    construction: { name: 'å»ºç­‘å­¦', icon: 'ğŸ—ï¸', description: 'è§£é”èŒ…å±‹å’Œä»“åº“', cost: { research: 80 }, requires: ['tools'] },
    mining: { name: 'é‡‡çŸ¿', icon: 'â›ï¸', description: 'è§£é”çŸ¿å·¥ã€é‡‡çŸ³åœºå’ŒçŸ¿äº•', cost: { research: 100 }, requires: ['tools'] },
    masonry: { name: 'çŸ³å·¥', icon: 'ğŸ§±', description: 'è§£é”æˆ¿å±‹', cost: { research: 120 }, requires: ['construction', 'mining'] },
    writing: { name: 'æ–‡å­—', icon: 'ğŸ“œ', description: 'è§£é”å›¾ä¹¦é¦†', cost: { research: 200 }, requires: ['agriculture'] },
    religion: { name: 'å®—æ•™', icon: 'âœï¸', description: 'è§£é”ç¥æ®¿å’Œç¥­å¸', cost: { research: 150, faith: 50 }, requires: ['construction'] },
    currency: { name: 'è´§å¸', icon: 'ğŸª™', description: 'è§£é”å¸‚åœºå’Œå•†äºº', cost: { research: 180 }, requires: ['mining'] },
    philosophy: { name: 'å“²å­¦', icon: 'ğŸ¤”', description: 'è§£é”å­¦é™¢', cost: { research: 500 }, requires: ['writing'] }
};

const EventManager = {
    events: [
        { id: 'harvest', name: 'ä¸°æ”¶', icon: 'ğŸŒ¾', chance: 0.05, condition: g => g.state.buildings.farm >= 2, effect: g => { g.addResource('food', 100); return 'è·å¾—100é£Ÿç‰©'; } },
        { id: 'fire', name: 'æ£®æ—ç«ç¾', icon: 'ğŸ”¥', chance: 0.03, condition: g => g.state.resources.wood.amount > 50, effect: g => { const l = Math.floor(g.state.resources.wood.amount * 0.2); g.consumeResource('wood', l); return `æŸå¤±${l}æœ¨æ`; } },
        { id: 'trader', name: 'æµæµªå•†äºº', icon: 'ğŸ§³', chance: 0.04, condition: g => g.state.resources.food.amount > 100, effect: g => { g.consumeResource('food', 50); g.addResource('gold', 10); return 'ç”¨50é£Ÿç‰©æ¢10é»„é‡‘'; } },
        { id: 'inspiration', name: 'çµå…‰ä¸€ç°', icon: 'ğŸ’¡', chance: 0.03, condition: g => g.state.population.jobs.scholar >= 1, effect: g => { g.addResource('research', 50); return 'è·å¾—50ç§‘ç ”ç‚¹'; } },
        { id: 'settlers', name: 'æ–°ç§»æ°‘', icon: 'ğŸ‘¥', chance: 0.02, condition: g => g.state.population.total < g.state.population.cap - 2, effect: g => { const n = Math.floor(Math.random() * 3) + 1; g.addPopulation(n); return `${n}åæ–°ç§»æ°‘åŠ å…¥`; } }
    ],
    checkEvents(g) { this.events.forEach(e => { if (Math.random() < e.chance && e.condition(g)) { const r = e.effect(g); this.logEvent(g, `[äº‹ä»¶] ${e.icon} ${e.name}: ${r}`); } }); },
    logEvent(g, m) { g.state.eventHistory.unshift({ time: Date.now(), year: Math.floor(g.state.year), message: m }); if (g.state.eventHistory.length > 50) g.state.eventHistory.pop(); document.getElementById('event-log').innerHTML = g.state.eventHistory.map(e => `<div class="log-entry">[ç¬¬${e.year}å¹´] ${e.message}</div>`).join(''); }
};

const SaveManager = {
    SAVE_KEY: 'civ_idle_save',
    save(g) { localStorage.setItem(this.SAVE_KEY, JSON.stringify({ t: Date.now(), s: g.state })); },
    load(g) { try { const d = localStorage.getItem(this.SAVE_KEY); if (d) { const p = JSON.parse(d); if (p.s) g.state = { ...g.state, ...p.s }; } } catch (e) {} },
    exportSave(g) { navigator.clipboard.writeText(btoa(JSON.stringify({ t: Date.now(), s: g.state }))).then(() => alert('å­˜æ¡£å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼')); },
    importSave(g) { const s = prompt('è¯·è¾“å…¥å­˜æ¡£ä»£ç ï¼š'); if (s) { try { g.state = JSON.parse(atob(s)).s; g.render(); alert('å­˜æ¡£åŠ è½½æˆåŠŸï¼'); } catch { alert('å­˜æ¡£ä»£ç æ— æ•ˆ'); } } }
};

class Game {
    constructor() {
        this.state = { year: 1, lastTick: Date.now(), resources: {}, buildings: {}, tech: {}, exploredTiles: [], eventHistory: [], population: { total: 0, idle: 0, cap: 10, happiness: 100, jobs: {} } };
        this.init();
    }
    init() {
        for (let k in ResourceDefinitions) this.state.resources[k] = { amount: ResourceDefinitions[k].initial, max: ResourceDefinitions[k].max, rate: 0 };
        for (let k in BuildingDefinitions) this.state.buildings[k] = 0;
        for (let k in TechDefinitions) this.state.tech[k] = { unlocked: TechDefinitions[k].startUnlocked, researched: false };
        for (let k in JobDefinitions) this.state.population.jobs[k] = 0;
        SaveManager.load(this);
        this.processOffline();
        setInterval(() => this.tick(), 1000);
        setInterval(() => this.render(), 100);
        this.render();
    }
    processOffline() {
        const offlineTime = (Date.now() - (localStorage.getItem('civ_idle_save') ? JSON.parse(localStorage.getItem('civ_idle_save')).t || Date.now() : Date.now())) / 1000;
        if (offlineTime > 60) {
            this.calculateRates();
            let gains = [];
            for (let k in this.state.resources) { const r = this.state.resources[k].rate; if (r > 0) { const g = r * Math.min(offlineTime, 86400) * 0.5; this.addResource(k, g); if (g > 1) gains.push(`${Math.floor(g)} ${ResourceDefinitions[k].name}`); } }
            if (gains.length > 0) { document.getElementById('offline-message').textContent = `ç¦»çº¿${Math.floor(offlineTime / 3600)}å°æ—¶ï¼Œè·å¾—ï¼š${gains.join('ã€')}`; document.getElementById('offline-popup').classList.remove('hidden'); }
        }
    }
    tick() { this.state.year += 0.01; this.calculateRates(); for (let k in this.state.resources) this.addResource(k, this.state.resources[k].rate); EventManager.checkEvents(this); this.save(); }
    calculateRates() { for (let k in this.state.resources) this.state.resources[k].rate = 0; for (let k in this.state.buildings) { const b = BuildingDefinitions[k], c = this.state.buildings[k]; if (c > 0 && b.production) for (let r in b.production) this.state.resources[r].rate += b.production[r] * c; } for (let k in this.state.population.jobs) { const j = JobDefinitions[k], c = this.state.population.jobs[k]; if (c > 0) { if (j.production) for (let r in j.production) this.state.resources[r].rate += j.production[r] * c; if (j.consumption) for (let r in j.consumption) this.state.resources[r].rate -= j.consumption[r] * c; } } }
    addResource(k, a) { const r = this.state.resources[k]; if (r) r.amount = Math.max(0, Math.min(r.amount + a, r.max)); }
    consumeResource(k, a) { this.addResource(k, -a); }
    canAfford(c) { for (let k in c) if (this.state.resources[k]?.amount < c[k]) return false; return true; }
    payCosts(c) { for (let k in c) this.consumeResource(k, c[k]); }
    addPopulation(n) { this.state.population.total += n; this.state.population.idle += n; }
    assignJob(k) { if (this.state.population.idle > 0) { this.state.population.jobs[k]++; this.state.population.idle--; this.render(); } }
    unassignJob(k) { if (this.state.population.jobs[k] > 0) { this.state.population.jobs[k]--; this.state.population.idle++; this.render(); } }
    recruit() { const c = 10 + Math.floor(this.state.population.total * 0.5); if (this.canAfford({ food: c }) && this.state.population.total < this.state.population.cap) { this.payCosts({ food: c }); this.addPopulation(1); this.render(); } }
    build(k) { const b = BuildingDefinitions[k], c = {}; for (let r in b.cost) c[r] = Math.floor(b.cost[r] * Math.pow(1.1, this.state.buildings[k])); if (this.canAfford(c)) { this.payCosts(c); this.state.buildings[k]++; if (b.effects) { if (b.effects.popCap) this.state.population.cap += b.effects.popCap; if (b.effects.resourceMax) for (let r in b.effects.resourceMax) this.state.resources[r].max += b.effects.resourceMax[r]; } this.render(); } }
    research(k) { const t = TechDefinitions[k], s = this.state.tech[k]; if (s.researched || !s.unlocked) return; for (let r of t.requires) if (!this.state.tech[r]?.researched) return; if (this.canAfford(t.cost)) { this.payCosts(t.cost); s.researched = true; for (let x in TechDefinitions) if (TechDefinitions[x].requires?.includes(k)) this.state.tech[x].unlocked = true; this.render(); } }
    render() {
        document.getElementById('year').textContent = Math.floor(this.state.year);
        document.getElementById('total-pop').textContent = this.state.population.total;
        document.getElementById('idle-pop').textContent = this.state.population.idle;
        document.getElementById('pop-cap').textContent = this.state.population.cap;
        document.getElementById('happiness').textContent = this.state.population.happiness + '%';
        document.getElementById('recruit-cost').textContent = 10 + Math.floor(this.state.population.total * 0.5);
        
        // Resources
        const rg = document.getElementById('resources-grid');
        rg.innerHTML = Object.keys(ResourceDefinitions).map(k => `<div class="resource-card"><div class="resource-icon">${ResourceDefinitions[k].icon}</div><div class="resource-name">${ResourceDefinitions[k].name}</div><div class="resource-amount">${Math.floor(this.state.resources[k].amount)}</div><div class="resource-max">/${this.state.resources[k].max === Infinity ? 'âˆ' : Math.floor(this.state.resources[k].max)}</div></div>`).join('');
        
        // Rates
        const pr = document.getElementById('production-rates');
        pr.innerHTML = Object.keys(ResourceDefinitions).map(k => { const r = this.state.resources[k].rate; return r !== 0 ? `<span class="rate ${r > 0 ? 'positive' : 'negative'}">${ResourceDefinitions[k].icon} ${r > 0 ? '+' : ''}${r.toFixed(1)}/s</span>` : ''; }).join('');
        
        // Jobs
        const jl = document.getElementById('jobs-list');
        jl.innerHTML = Object.keys(JobDefinitions).map(k => `<div class="job-item"><div class="job-info"><span class="job-icon">${JobDefinitions[k].icon}</span><div><div class="job-name">${JobDefinitions[k].name}</div><div class="job-desc">${JobDefinitions[k].description}</div></div></div><div class="job-controls"><button onclick="game.unassignJob('${k}')" ${this.state.population.jobs[k] === 0 ? 'disabled' : ''}>-</button><span>${this.state.population.jobs[k]}</span><button onclick="game.assignJob('${k}')" ${this.state.population.idle === 0 ? 'disabled' : ''}>+</button></div></div>`).join('');
        
        // Buildings
        const bl = document.getElementById('buildings-list');
        bl.innerHTML = Object.keys(BuildingDefinitions).map(k => {
            const b = BuildingDefinitions[k];
            if (b.requireTech && !this.state.tech[b.requireTech]?.researched) return '';
            const c = {}; for (let r in b.cost) c[r] = Math.floor(b.cost[r] * Math.pow(1.1, this.state.buildings[k]));
            const a = this.canAfford(c);
            return `<div class="building-item ${a ? '' : 'disabled'}"><div class="building-info"><span class="building-icon">${b.icon}</span><div><div class="building-name">${b.name} (${this.state.buildings[k]})</div><div class="building-desc">${b.description}</div><div class="building-cost">${Object.entries(c).map(([r, n]) => `<span class="${this.state.resources[r]?.amount >= n ? 'can-afford' : 'cannot-afford'}">${Math.floor(n)} ${ResourceDefinitions[r]?.icon}</span>`).join(' ')}</div></div></div><button onclick="game.build('${k}')" ${a ? '' : 'disabled'}>å»ºé€ </button></div>`;
        }).join('');
        
        // Tech
        const tt = document.getElementById('tech-tree');
        tt.innerHTML = Object.keys(TechDefinitions).map(k => {
            const t = TechDefinitions[k], s = this.state.tech[k];
            if (!s.unlocked && !t.startUnlocked) return '';
            const a = this.canAfford(t.cost);
            return `<div class="tech-item ${s.researched ? 'researched' : ''} ${a ? '' : 'disabled'}"><div class="tech-info"><span class="tech-icon">${t.icon}</span><div><div class="tech-name">${t.name} ${s.researched ? 'âœ“' : ''}</div><div class="tech-desc">${t.description}</div><div class="tech-cost">${Object.entries(t.cost).map(([r, n]) => `<span class="${this.state.resources[r]?.amount >= n ? 'can-afford' : 'cannot-afford'}">${Math.floor(n)} ${ResourceDefinitions[r]?.icon || r}</span>`).join(' ')}</div></div></div><button onclick="game.research('${k}')" ${s.researched || !a ? 'disabled' : ''}>${s.researched ? 'å·²å®Œæˆ' : 'ç ”ç©¶'}</button></div>`;
        }).join('');
    }
    save() { SaveManager.save(this); }
    exportSave() { SaveManager.exportSave(this); }
    importSave() { SaveManager.importSave(this); }
    hardReset() { if (confirm('ç¡®å®šé‡ç½®æ‰€æœ‰è¿›åº¦ï¼Ÿ')) { localStorage.removeItem('civ_idle_save'); location.reload(); } }
}

let game;
document.addEventListener('DOMContentLoaded', () => {
    game = new Game();
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab + '-panel').classList.add('active');
        });
    });
    document.getElementById('recruit-btn').addEventListener('click', () => game.recruit());
});
function dismissOffline() { document.getElementById('offline-popup').classList.add('hidden'); }
    </script>
</body>
</html>
